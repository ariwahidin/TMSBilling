@model IEnumerable<TMSBilling.Controllers.JobSummaryViewModel>

@{
    Layout = "~/Views/Shared/_MainLayout.cshtml";
    ViewData["Title"] = "Job List";
}




<div class="mb-3">
    <a href="/Job/Form" class="btn btn-primary btn-sm">
        <i class="bi bi-plus"></i> Create New Job
    </a>
    <button id="btnSyncJob" class="btn btn-info btn-sm">
        <i class="bi bi-check-circle"></i> Sync Job
    </button>
    <button id="btnBulkConfirm" class="btn btn-warning btn-sm" style="display:none;">
        <i class="bi bi-check-circle"></i> POD Selected (<span id="selectedCount">0</span>)
    </button>
</div>

<!-- Filter Date Range - Compact Design -->
<div class="mb-2">
    <div class="card mb-3">
        <div class="card-body py-2">
            <form method="get" action="/Job/Index" class="d-inline-flex align-items-center gap-2">
                <label class="form-label mb-0 text-muted">Delivery Date:</label>
                <input type="date" name="startDate" class="form-control form-control-sm"
                       value="@ViewBag.StartDate" style="width: 130px;" required>
                <span class="text-muted">to</span>
                <input type="date" name="endDate" class="form-control form-control-sm"
                       value="@ViewBag.EndDate" style="width: 130px; font-size: 12px;" required>
                <button type="submit" class="btn btn-secondary btn-sm" style="padding: 2px 10px;">
                    <i class="bi bi-funnel"></i> Filter
                </button>
                <a href="/Job/Index" class="btn btn-outline-secondary btn-sm" style="padding: 2px 10px;">
                    <i class="bi bi-arrow-clockwise"></i> Reset
                </a>
            </form>
        </div>
    </div>
</div>

<table class="table table-sm table-bordered table-hover table-striped align-middle" id="tableJob">
    <thead class="table-light">
        <tr>
            <th><input type="checkbox" id="checkAll" title="Select All"></th>
            <th>#</th>
            <th>Job ID</th>
            <th>Status</th>
            <th>Truck ID</th>
            <th>Delivery Date</th>
            <th>Origin</th>
            <th>Destination</th>
            <th>Vendor ID</th>
            <th>Total DO</th>
            <th class="text-center">Action</th>
        </tr>
        <tr>
            <th></th>
            <th></th>
            <th><input type="text" class="form-control form-control-sm" placeholder="Search Job ID"></th>
            <th><input type="text" class="form-control form-control-sm" placeholder="Search Status"></th>
            <th><input type="text" class="form-control form-control-sm" placeholder="Search Truck"></th>
            <th><input type="text" class="form-control form-control-sm" placeholder="Search Date"></th>
            <th><input type="text" class="form-control form-control-sm" placeholder="Search Origin"></th>
            <th><input type="text" class="form-control form-control-sm" placeholder="Search Destination"></th>
            <th><input type="text" class="form-control form-control-sm" placeholder="Search Vendor"></th>
            <th></th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        @{
            var i = 1;
            foreach (var item in Model)
            {
                <tr>
                    <td>
                      <input type="checkbox" class="order-checkbox" data-order-id="@item.IdSeq">
                    </td>
                    <td>@i</td>
                    <td>@item.JobId</td>
                    <td>@item.MCStatus</td>
                    <td>@item.TruckNo</td>
                    <td>@item.DelivDate?.ToString("yyyy-MM-dd")</td>
                    <td>@item.Origin</td>
                    <td>@item.Dest</td>
                    <td>@item.VendorPlan</td>
                    <td>@item.TotalDo</td>
                    <td class="text-center">
                        <a href="/Job/Form/@item.JobId" class="text-primary me-2">
                            <i class="bi bi-pencil-square"></i>
                        </a>
                        <a href="#" class="text-danger" onclick="confirmDelete('@item.JobId')">
                            <i class="bi bi-trash"></i>
                        </a>
                    </td>
                </tr>
                i++;
            }
        }
    </tbody>
</table>

@section Scripts {
    <script>
        // Delete confirmation
        function confirmDelete(id) {
            Swal.fire({
                icon: 'warning',
                title: 'Are you sure?',
                text: 'This action cannot be undone.',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/Job/Delete/${id}`, { method: 'POST' })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                Swal.fire('Deleted!', 'The job has been deleted.', 'success').then(() => {
                                    location.reload();
                                });
                            } else {
                                Swal.fire('Error', data.message || 'Delete failed.', 'error');
                            }
                        });
                }
            });
        }

        $(document).ready(() => {
            var table = $('#tableJob').DataTable({
                orderCellsTop: true,
                fixedHeader: true,
                pageLength: 25,
                language: { emptyTable: "No jobs available" }
            });

            // Filter per kolom
            $('#tableJob thead tr:eq(1) th').each(function (i) {
                $('input', this).on('keyup change', function () {
                    if (table.column(i).search() !== this.value) {
                        table.column(i).search(this.value).draw();
                    }
                });
            });

            // Sync Job handler
            $('#btnSyncJob').on('click', function () {
                Swal.fire({
                    title: 'Syncing...',
                    text: 'Please wait while we synchronize jobs.',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                $.ajax({
                    url: '/Job/SyncronizeFO',
                    method: 'POST',
                    dataType: 'json',
                    success: function (response) {
                        Swal.close();
                        if (response.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Synchronization Successful',
                                text: response.message,
                                confirmButtonColor: '#3085d6'
                            }).then(() => window.location.reload());
                        } else {
                            Swal.fire('Failed', response.message || 'Synchronization failed.', 'warning');
                        }
                    },
                    error: function (xhr) {
                        Swal.close();
                        Swal.fire('Error', xhr.responseText || 'Server not responding.', 'error');
                    }
                });
            });
        });
    </script>

    <script>
        let selectedOrders = new Set();

        function updateSelectedCount() {
            const count = selectedOrders.size;
            $('#selectedCount').text(count);
            $('#btnBulkConfirm').toggle(count > 0);
        }

        function updateCheckAllStatus() {
            const visibleCheckboxes = $('.order-checkbox:visible');
            const checkedVisible = visibleCheckboxes.filter(':checked').length;

            if (visibleCheckboxes.length === 0) {
                $('#checkAll').prop('checked', false).prop('indeterminate', false);
            } else if (checkedVisible === 0) {
                $('#checkAll').prop('checked', false).prop('indeterminate', false);
            } else if (checkedVisible === visibleCheckboxes.length) {
                $('#checkAll').prop('checked', true).prop('indeterminate', false);
            } else {
                $('#checkAll').prop('checked', false).prop('indeterminate', true);
            }
        }

        // Check All handler
        $('#checkAll').on('change', function() {
            const isChecked = $(this).prop('checked');
            $('.order-checkbox:visible').each(function() {
                const orderId = $(this).data('order-id');
                $(this).prop('checked', isChecked);

                if (isChecked) {
                    selectedOrders.add(orderId);
                } else {
                    selectedOrders.delete(orderId);
                }
            });
            updateSelectedCount();
        });

        // Individual checkbox handler
        $(document).on('change', '.order-checkbox', function() {
            const orderId = $(this).data('order-id');

            if ($(this).prop('checked')) {
                selectedOrders.add(orderId);
            } else {
                selectedOrders.delete(orderId);
            }

            updateSelectedCount();
            updateCheckAllStatus();
        });

        function bulkConfirmOrders() {
            if (selectedOrders.size === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'No Selection',
                    text: 'Please select at least one order to POD Job.'
                });
                return;
            }

            const orderIds = Array.from(selectedOrders);

            console.log("Order Selecteds : ", orderIds);

            fetch('/Job/BulkJobPod', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(orderIds)
            })
            .then(res => res.json())
            .then(res => {
                if (res.success) {
                    // pindah ke halaman edit
                    window.location.href = res.redirectUrl;
                } else {
                    Swal.fire('Error', res.message, 'error');
                }
            })
            .catch(err => {
                console.error(err);
                Swal.fire('Error', 'Server error', 'error');
            });
        }


        // Bulk confirm button handler
        $('#btnBulkConfirm').on('click', bulkConfirmOrders);


    </script>

    @* <style>
        /* Compact mode */
        #tableJob th, #tableJob td {
            padding: 4px 6px !important;
            font-size: 13px;
        }

        /* Placeholder kecil */
        #tableJob input::placeholder {
            font-size: 11px;
            opacity: 0.7;
        }

        #tableJob input.form-control-sm {
            height: 24px;
            padding: 2px 6px;
        }
    </style> *@

    <style>
        /* Compact mode */
        #tableJob th, #tableJob td {
            padding: 4px 6px !important;
            font-size: 13px;
        }

        /* Placeholder kecil */
        #tableJob input::placeholder {
            font-size: 11px;
            opacity: 0.7;
        }

        #tableJob input.form-control-sm {
            height: 24px;
            padding: 2px 6px;
        }

        /* Filter date styling - minimalis */
        input[type="date"].form-control-sm {
            height: 26px;
            padding: 2px 6px;
            font-size: 12px;
        }
    </style>
}
