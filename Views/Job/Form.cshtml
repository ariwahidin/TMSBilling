@model TMSBilling.Models.ViewModels.JobViewModel
@{
    Layout = "~/Views/Shared/_MainLayout.cshtml";
    ViewData["Title"] = "Job Form";
}

<style>
    .form-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 30px;
        margin: 0 auto;
        max-width: 100%;
    }

    .form-header {
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 20px;
        margin-bottom: 30px;
    }

    .form-title {
        color: #2c3e50;
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 0;
    }

    .header-section {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 20px;
        margin-bottom: 30px;
    }

    .header-title {
        color: #495057;
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
    }

        .header-title i {
            margin-right: 8px;
            color: #6c757d;
        }

    .select2-container--default .select2-selection--single {
        height: 25px;
        border: 1px solid #ced4da;
        border-radius: 4px;
    }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 25px;
            padding-left: 12px;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 25px;
        }

    .detail-section {
        margin-top: 30px;
    }

    .detail-title {
        color: #495057;
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
    }

        .detail-title i {
            margin-right: 8px;
            color: #6c757d;
        }

    .excel-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        overflow: hidden;
    }

        .excel-table th {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 8px 6px;
            text-align: center;
            font-weight: 600;
            color: #495057;
            font-size: 11px;
            white-space: nowrap;
        }

        .excel-table td {
            border: 1px solid #dee2e6;
            padding: 2px;
            vertical-align: middle;
        }

        .excel-table input,
        .excel-table select {
            width: 100%;
            /* border: none; */
            padding: 6px 8px;
            font-size: 12px;
            background: transparent;
            /* outline: none; */
            min-height: 20px;
        }

            .excel-table input:focus,
            .excel-table select:focus {
                background: #e3f2fd;
            }

        .excel-table .number-input {
            text-align: right;
        }

    .action-btn {
        background: #dc3545;
        color: white;
        border: none;
        padding: 6px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: background 0.3s;
    }

        .action-btn:hover {
            background: #c82333;
        }

    .btn-add-row {
        background: #28a745;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin-top: 10px;
        transition: background 0.3s;
    }

        .btn-add-row:hover {
            background: #218838;
        }

    .form-actions {
        display: flex;
        gap: 15px;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #e9ecef;
        justify-content: flex-end;
    }

    .btn-save {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: background 0.3s;
    }

        .btn-save:hover {
            background: #0056b3;
        }

    .btn-cancel {
        background: #6c757d;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: background 0.3s;
    }

        .btn-cancel:hover {
            background: #545b62;
        }

    .col-narrow {
        width: 80px;
    }

    .col-action {
        width: 60px;
    }

    .table-container {
        overflow-x: auto;
        border: 1px solid #dee2e6;
        border-radius: 6px;
    }

    .row-number {
        background: #f8f9fa;
        text-align: center;
        font-weight: 600;
        color: #6c757d;
        width: 40px;
    }

    .header-section * {
        font-size: 12px;
    }
</style>
<a href="/Job/Index" class="btn btn-sm btn-primary mb-2"> <i class="bi bi-arrow-left"></i> Back</a>
<a href="/Job/Form" class="btn btn-sm btn-warning mb-2"> <i class="bi bi-arrow-clockwise"></i> Reset</a>
<div class="form-container">

    @* Debug sementara *@
    @* <p>Origin ID: @Model.Header.origin_id</p>
    <p>Truck Size: @Model.Header.truck_size</p> *@

    <form id="orderForm">
        <div class="header-section">
            <div class="row">
                <div class="col-md-4">
                    <div class="mb-2 row">
                        <label class="col-sm-4 col-form-label text-end">Job ID : </label>
                        <div class="col-sm-8">
                            <input type="text" id="jobid" name="jobid" class="form-control" readonly value="@Model.Header.jobid" />
                        </div>
                    </div>
                    <div class="mb-2 row">
                        <label class="col-sm-4 col-form-label text-end">Delivery Date : </label>
                        <div class="col-sm-8">
                            <input type="date" id="dv_date" name="dv_date" class="form-control" value="@(Model.Header.dvdate?.ToString("yyyy-MM-dd"))" />
                        </div>
                    </div>
                    <div class="mb-2 row">
                        <label class="col-sm-4 col-form-label text-end">Origin : </label>
                        <div class="col-sm-8">
                            <select id="origin_id" asp-for="Header.origin_id" asp-items="ViewBag.ListOrigin" class="form-select select2" required>
                                <option value="">Select an Option</option>
                            </select>
                        </div>
                    </div>   
                    <div class="mb-2 row">
                        <label class="col-sm-4 col-form-label text-end">Destination : </label>
                        <div class="col-sm-8">
                            <select id="dest_id" asp-for="Header.dest_id" asp-items="ViewBag.ListDestination" class="form-select select2" required>
                                <option value="">Select an Option</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-2 row">
                        <label class="col-sm-4 col-form-label text-end">Truck Size : </label>
                        <div class="col-sm-8">
                            <select id="truck_size" asp-for="Header.truck_size" asp-items="ViewBag.ListTruckSize" class="form-select select2" required>
                                <option value="">Select an Option</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-2 row">
                        <label class="col-sm-4 col-form-label text-end">Plan Vendor : </label>
                        <div class="col-sm-8">
                            @* <input type="text" id="vendorid" name="vendorid" class="form-control" readonly value="@Model.Header.vendorid" /> *@
                            <select id="vendorid" name="vendorid" class="form-select" disabled>
                                @* <option value="">Select a vendor</option> *@
                            </select>
                        </div>
                    </div>
                    <div class="mb-2 row">
                        <label class="col-sm-4 col-form-label text-end">Act Vendor : </label>
                        <div class="col-sm-8">
                            <select id="vendorid_act" name="vendorid_act" class="form-select" disabled>
                                @* <option value="">Select a vendor</option> *@
                            </select>
                        </div>
                    </div>
                    <div class="mb-2 row">
                        <label class="col-sm-4 col-form-label text-end">Truck ID : </label>
                        <div class="col-sm-8">
                            <select id="truckid" name="truckid" class="form-select" disabled>
                                @* <option value="">Select a vendor</option> *@
                            </select>
                        </div>
                    </div>
                    <div class="mb-2 row">
                        <label class="col-sm-4 col-form-label text-end">Driver Name : </label>
                        <div class="col-sm-8">
                            <select id="drivername" name="drivername" class="form-select" disabled>
                                @* <option value="">Select a vendor</option> *@
                            </select>
                        </div>
                    </div>
                    <div class="mb-2 row">
                        <label class="col-sm-4 col-form-label text-end">Job Remark : </label>
                        <div class="col-sm-8">
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-2 row">
                        <label class="col-sm-4 col-form-label text-end">Pickup Cargo : </label>
                        <div class="col-sm-8">
                            <select id="flag_rc" asp-for="Header.flag_rc" asp-items="ViewBag.ListPickupCargo" class="form-select select2" required>
                                @* <option value="">Select an Option</option> *@
                            </select>
                        </div>
                    </div>
                    <div class="mb-2 row">
                        <label class="col-sm-4 col-form-label text-end">Multi Drop : </label>
                        <div class="col-sm-8">
                            <select id="multidrop" asp-for="Header.multidrop" asp-items="ViewBag.ListMultiDrop" class="form-select select2" required>
                                @* <option value="">Select an Option</option> *@
                            </select>
                        </div>
                    </div>
                    <div class="mb-2 row">
                        <label class="col-sm-4 col-form-label text-end">Multi Trip : </label>
                        <div class="col-sm-8">
                            <select id="multitrip" asp-for="Header.multitrip" asp-items="ViewBag.ListMultitrip" class="form-select select2" required>
                                @* <option value="">Select an Option</option> *@
                            </select>
                        </div>
                    </div>
                    <div class="mb-2 row">
                        <label class="col-sm-4 col-form-label text-end">No Trip : </label>
                        <div class="col-sm-8">
                            <input type="text" id="ritase_seq" name="ritase_seq" class="form-control" readonly value="@Model.Header.ritase_seq" />
                        </div>
                    </div>
                    <div class="mb-2 row">
                        <label class="col-sm-4 col-form-label text-end">Cost/Sell : </label>
                        <div class="col-sm-8">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="detail-section">
            <div class="table-container">
                <table class="excel-table">
                    <thead>
                        <tr>
                            <th class="row-number">#</th>
                            <th class="row-number">Drop</th>
                            <th class="col-narrow">WH Code</th>
                            <th class="col-narrow">Invoice No</th>
                            <th class="col-narrow">Cust Code</th>
                            <th class="col-narrow">Cnee Code</th>
                            <th class="col-narrow">Destination</th>
                            <th class="col-action">Total <br> PKGS</th>
                            <th class="col-action">Total <br> Pallet</th>
                            <th class="col-action">Truck <br> Size</th>
                            <th class="col-action">Remark</th>
                            <th class="col-action">Empty <br> Pallet</th>
                            <th class="col-action">Return <br> Cargo</th>
                            <th class="col-action">Over <br> Night</th>
                            <th class="col-action">Cancel <br> Cargo</th>
                            <th class="col-action text-center">Deff <br> Area</th>
                        </tr>
                    </thead>
                    <tbody id="detailTableBody">
                    </tbody>
                </table>
            </div>

            @if (Model.Header.jobid != null)
            {
                <button type="button" class="btn btn-sm btn-success mt-2" id="show_order">
                    <i class="fas fa-plus"></i> Show all order
                </button>
            }
        </div>
        <div class="form-actions">
            <button type="button" class="btn-cancel btn-sm" onclick="resetForm()">
                <i class="fas fa-times"></i> Cancel
            </button>
            <button type="submit" class="btn-save btn-sm" data-action="save">
                <i class="fas fa-save"></i> Save
            </button>

            @if (Model.Header.id_seq == 0)
            {
                <button type="submit" class="btn btn-info btn-sm" data-action="save_new">
                    <i class="fas fa-save"></i> Save And New
                </button>
            }
        </div>
    </form>
</div>


@section Scripts{
    <script>
        $(document).ready(function(){
            @if (Model.Header != null && !string.IsNullOrEmpty(Model.Header.jobid))
            {
                <text>
                    // Mode edit aktif
                    const origin = "@Model.Header.origin_id";
                    const dest = "@Model.Header.dest_id";
                    const truckSize = "@Model.Header.truck_size";
                    const selectedVendor = "@Model.Header.vendorid";

                    // Set nilai dropdown
                    $('#origin_id').val(origin).trigger('change');
                    $('#dest_id').val(dest).trigger('change');
                    $('#truck_size').val(truckSize).trigger('change');

                    // Tunggu sebentar agar dropdown-nya terisi, lalu fetch vendor
                    setTimeout(function (){
                        fetchVendorsEdit(origin, dest, truckSize, selectedVendor)
                    }, 300)
                </text>
            }

            

            $('#dv_date').on('change', function(){
                const selectedDate = $(this).val(); // Ambil value dari input date
                console.log("Tanggal dipilih:", selectedDate);

                $.ajax({
                    url: '/Job/GetOrdersByDate',
                    type: 'GET',
                    data: { date: selectedDate },
                    success: function(response) {
                            if (response.success) {
                                renderTable(response.data);
                            } else {
                                alert(response.message);
                            }
                    },
                    error: function() {
                        alert("Terjadi kesalahan saat mengambil data.");
                    }
                });

            });

            $('#orderForm').on('submit', function (e) {
                e.preventDefault();
                handleSave(); 
            });

            $('#origin_id, #dest_id, #truck_size').on('change', checkAndFetchVendor);
            $('#vendorid').on('change', function(){
                console.log('sssss')
            })

            $('#show_order').on('click', showOrder)
        });

        const jobid = $('#jobid').val();
        if (jobid) {
            fetchDetail(jobid);
        }

        function showOrder(){
            const deliv_date = $('#dv_date').val();
            const job_id = $('#jobid').val();

            if(job_id != ''){
                $.ajax({
                    url: '/Job/GetOrdersByDate',
                    type: 'GET',
                    data: { date: deliv_date, jobid : job_id },
                    success: function(response) {
                            if (response.success) {
                                renderTable(response.data);
                            } else {
                                alert(response.message);
                            }
                    },
                    error: function() {
                        alert("Terjadi kesalahan saat mengambil data.");
                    }
                });
            }
        }

        function fetchVendorsEdit(originId, destId, truckSize) {
            $.ajax({
                url: '/Job/GetVendors',
                type: 'GET',
                data: {
                    originId: originId,
                    destId: destId,
                    truckSize: truckSize
                },
                success: function (data) {
                    if (data.success && data.vendors.length > 0) {
                        const $vendorSelect = $('#vendorid');
                        $vendorSelect.empty();
                        data.vendors.forEach(v => {
                            $vendorSelect.append(`<option value="${v.supCode}">${v.supName}</option>`);
                        });
                        $vendorSelect.prop('disabled', false);
                        $vendorSelect.val(data.vendors[0].supCode);

                        loadDriversByVendor(data.vendors[0].supCode);
                    }
                },
                error: function () {
                    Swal.fire('Error', 'Gagal mengambil vendor.', 'error');
                }
            });
        }

        function checkAndFetchVendor() {
            const originId = $('#origin_id').val();
            const destId = $('#dest_id').val();
            const truckSize = $('#truck_size').val();

            if (originId && destId && truckSize) {
                $.ajax({
                    url: '/Job/GetVendors',
                    type: 'GET',
                    data: {
                        originId: originId,
                        destId: destId,
                        truckSize : truckSize
                    },
                    success: function (data) {
                        if (data.success && data.vendors.length > 0) {
                            const $vendorSelect = $('#vendorid');
                            $vendorSelect.empty(); // kosongkan dulu
                            data.vendors.forEach(v => {
                                $vendorSelect.append(`<option value="${v.supCode}">${v.supName}</option>`);
                            });
                            $vendorSelect.prop('disabled', false);
                            // ✅ PILIH opsi pertama
                            const selectedCode = data.vendors[0].supCode;
                            $vendorSelect.val(selectedCode);

                            // ✅ TRIGGER AMBIL DRIVER BERDASARKAN supCode
                            loadDriversByVendor(selectedCode);

                        } else {
                            $('#vendorid').val('');
                            // alert(data.message || 'Vendor not found');
                        }
                    },
                    error: function () {
                        // alert('Failed to fetch vendor');
                        $('#vendorid').val('');
                    }
                });
            }
        }

        function loadDriversByVendor(supCode) {
            $.ajax({
                url: '/Job/GetDriversByVendor',
                type: 'GET',
                data: { supCode: supCode },
                success: function(response) {
                    if (response.success) {
                        const $driverSelect = $('#drivername'); // ganti jika id-nya beda
                        $driverSelect.empty();
                        response.drivers.forEach(d => {
                            $driverSelect.append(`<option value="${d.driverName}">${d.driverName}</option>`);
                        });
                        $driverSelect.prop('disabled', false);


                        const $truckIdSelect = $('#truckid');
                        $truckIdSelect.empty();
                        response.drivers.forEach(d => {
                            $truckIdSelect.append(`<option value="${d.truckId}">${d.truckId}</option>`);
                        });
                        $truckIdSelect.prop('disabled', false);
                    } else {
                        Swal.fire('Info', 'Tidak ada driver untuk vendor ini.', 'info');
                    }
                },
                error: function () {
                    Swal.fire('Error', 'Gagal mengambil data driver.', 'error');
                }
            });
        }

        function handleSave() {
            const rows = $('#detailTableBody tr');

            const header = {
                            job_id : $('#jobid').val(),
                            origin_id : $('#origin_id').val(),
                            dest_area : $('#dest_id').val(),
                            vendor_id : $('#vendorid').val(),
                            truck_id : $('#truckid').val(),
                            driver_name : $('#drivername').val(),
                            delivery_date : $('#dv_date').val(),
                            truck_size : $('#truck_size').val(),
                        };
            const details = [];
            

            rows.each(function (i, row) {
                const isChecked = $(row).find('input[type="checkbox"][name^="Details["]').is(':checked');
                if (isChecked) {
                    const detail = {
                        is_selected: $(row).find('[name*=".IsSelected"]').is(':checked'),
                        drop_seq: $(row).find('[name*=".drop_seq"]').val(),
                        wh_code: $(row).find('[name*=".wh_code"]').val(),
                        inv_no: $(row).find('[name*=".inv_no"]').val(),
                        sub_custid: $(row).find('[name*=".sub_custid"]').val(),
                        cnee_code: $(row).find('[name*=".cnee_code"]').val(),
                        dest_area: $(row).find('[name*=".dest_area"]').val(),
                        tot_pkgs: $(row).find('[name*=".tot_pkgs"]').val(),
                        tot_pallet: $(row).find('[name*=".tot_pallet"]').val(),
                        truck_size: $(row).find('[name*=".truck_size"]').val(),
                        remark: $(row).find('[name*=".remark"]').val(),
                        empty_pallet: $(row).find('[name*=".empty_pallet"]').val(),
                        return_cargo: $(row).find('[name*=".return_cargo"]').val(),
                        overnight: $(row).find('[name*=".overnight"]').val(),
                        cancel_cargo: $(row).find('[name*=".cancel_cargo"]').val(),
                        deff_area: $(row).find('[name*=".deff_area"]').val(),
                    };
                    details.push(detail);
                }
            });

            const dataToSave = {FormJobHeader : header, FormJobDetails :details}

            // Kirim lewat AJAX

            let url = '/Job/Save';
            const jobid = $('#jobid').val();

            if(jobid != ""){
                url = '/Job/Save/'+jobid
            }
            $.ajax({
                url: url,
                type: 'POST',
                data: JSON.stringify(dataToSave),
                contentType: 'application/json',
                success: function (res) {
                    Swal.fire('Success', res.message, 'success');
                },
                error: function (e) {
                    console.log(e)
                    // Swal.fire('Oops!', 'Terjadi kesalahan saat menyimpan data.', 'error');
                }
            });
        }

        function renderTable(data) {
            const tbody = $('#detailTableBody');
            tbody.empty();

            if (!data || data.length === 0) {
                tbody.append(`<tr><td colspan="15" class="text-center">Tidak ada data</td></tr>`);
                return;
            }

            data.forEach((item, index) => {
                const renderYesNoSelect = (name, selected) => {
                    return `
                        <select class="form-select form-select-sm" name="${name}">
                            <option value="No" ${selected === "No" ? 'selected' : ''}>No</option>
                            <option value="Yes" ${selected === "Yes" ? 'selected' : ''}>Yes</option>
                        </select>`;
                };

                const row = `
                    <tr>
                        <td class="text-center">
                            <input type="checkbox" name="Details[${index}].IsSelected" value="true" ${item.order_status === 1 ? 'checked' : ''} />
                        </td>
                        <td>
                            <input type="number" name="Details[${index}].drop_seq" value="${index + 1}" class="form-control form-control-sm" style="width:50px;" />
                        </td>
                        <td><input readonly type="text" name="Details[${index}].wh_code" class="form-control form-control-sm" value="${item.wh_code || ''}" /></td>
                        <td><input readonly type="text" name="Details[${index}].inv_no" class="form-control form-control-sm" value="${item.inv_no || ''}" /></td>
                        <td><input readonly type="text" name="Details[${index}].sub_custid" class="form-control form-control-sm" value="${item.sub_custid || ''}" /></td>
                        <td><input readonly type="text" name="Details[${index}].cnee_code" class="form-control form-control-sm" value="${item.sub_custid || ''}" /></td>
                        <td><input readonly type="text" name="Details[${index}].dest_area" class="form-control form-control-sm" value="${item.dest_area || ''}" /></td>
                        <td><input readonly type="number" name="Details[${index}].tot_pkgs" class="form-control form-control-sm text-end" value="${item.tot_pkgs || ''}" /></td>
                        <td><input type="number" name="Details[${index}].tot_pallet" class="form-control form-control-sm text-end" value="${item.tot_pallet || 0}" /></td>
                        <td><input type="text" name="Details[${index}].truck_size" class="form-control form-control-sm" value="${item.truck_size || ''}" /></td>
                        <td><input type="text" name="Details[${index}].remark" class="form-control form-control-sm" value="${item.remark || ''}" /></td>
                        <td>${renderYesNoSelect(`Details[${index}].empty_pallet`, item.empty_pallet)}</td>
                        <td>${renderYesNoSelect(`Details[${index}].return_cargo`, item.return_cargo)}</td>
                        <td>${renderYesNoSelect(`Details[${index}].overnight`, item.overnight)}</td>
                        <td>${renderYesNoSelect(`Details[${index}].cancel_cargo`, item.cancel_cargo)}</td>
                        <td>${renderYesNoSelect(`Details[${index}].deff_area`, item.deff_area)}</td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        function fetchDetail(jobid) {
            $.ajax({
                url: '/Job/GetJobDetails',
                type: 'GET',
                data: { jobid: jobid },
                success: function (res) {
                    if (res.success && res.data.length > 0) {
                        renderTable(res.data);
                    } else {
                        console.log('No detail data');
                    }
                },
                error: function () {
                    Swal.fire('Oops', 'Gagal mengambil data detail', 'error');
                }
            });
        }
    </script>
}