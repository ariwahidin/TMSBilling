@model TMSBilling.Models.ViewModels.JobViewModel
@{
    Layout = "~/Views/Shared/_MainLayout.cshtml";
    ViewData["Title"] = "Job Form";
}

<style>
        .form-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
            margin: 0 auto;
            max-width: 100%;
        }

        .header-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .detail-section {
            margin-top: 30px;
        }

        .excel-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            overflow: hidden;
        }

            .excel-table th {
                background: #f8f9fa;
                border: 1px solid #dee2e6;
                padding: 8px 6px;
                text-align: center;
                font-weight: 600;
                color: #495057;
                font-size: 11px;
                white-space: nowrap;
            }

            .excel-table td {
                border: 1px solid #dee2e6;
                padding: 4px;
                vertical-align: middle;
            }

            .excel-table input,
            .excel-table select {
                width: 100%;
                padding: 4px 6px;
                font-size: 11px;
                background: transparent;
                border: 1px solid #ced4da;
                border-radius: 3px;
                min-height: 25px;
            }

                .excel-table input:focus,
                .excel-table select:focus {
                    background: #e3f2fd;
                    outline: none;
                    border-color: #007bff;
                }

        .modal-xl {
            max-width: 95%;
        }

        .order-table {
            font-size: 11px;
        }

            .order-table th {
                background: #343a40;
                color: white;
                text-align: center;
                padding: 8px 4px;
                white-space: nowrap;
            }

            .order-table td {
                padding: 4px;
                text-align: center;
            }

        .btn-add-order {
            background: #28a745;
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

            .btn-add-order:hover {
                background: #218838;
            }

        .selected-orders-count {
            background: #17a2b8;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin-left: 10px;
        }

        .table-container {
            overflow-x: auto;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            max-height: 400px;
        }

        .position-relative-custom {
            position: relative;
        }

        .input-group-append-custom {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10;
        }

        .form-control-with-button {
            padding-right: 45px !important;
        }

    .address-search {
        max-height: 400px;
        overflow-y: auto;
    }

    .vendor-item {
        cursor: pointer;
        padding: 12px;
        border: 1px solid #dee2e6;
        margin-bottom: 8px;
        border-radius: 6px;
        transition: all 0.3s;
    }

        .vendor-item:hover {
            background-color: #f8f9fa;
            border-color: #007bff;
        }

        .vendor-item.disabled {
            opacity: 0.6;
            cursor: not-allowed !important;
            background-color: #f8f9fa;
        }

            .vendor-item.disabled:hover {
                background-color: #f8f9fa !important;
                border-color: #dee2e6 !important;
            }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }
    </style>

    <div class="container-fluid py-1">
        <div class="d-flex gap-2 mb-3">
        <button class="btn btn-sm btn-primary" onclick="window.location.href='/Job/Index'">
                <i class="bi bi-arrow-left"></i> Back
            </button>
            <button class="btn btn-sm btn-warning">
                <i class="bi bi-arrow-clockwise"></i> Reset
            </button>
        </div>

        <div class="form-container">
            <form id="orderForm">
                <!-- Header Section -->
                <div class="header-section" style="font-size:12px;">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-2 row">
                                <label class="col-sm-4 col-form-label text-end">Job ID:</label>
                                <div class="col-sm-8">
                                    <input style="font-size:12px" type="text" asp-for="Header.jobid" id="jobid" name="jobid" class="form-control form-control-sm" readonly placeholder="Auto Generate" />
                                </div>
                            </div>
                            <div class="mb-2 row">
                                <label class="col-sm-4 col-form-label text-end">Pickup Date:</label>
                                <div class="col-sm-8">
                                    <input style="font-size:12px;" type="datetime-local" asp-for="Header.pickup_date" id="pickup_date" name="pickup_date" class="form-control" />
                                </div>
                            </div>
                            <div class="mb-2 row">
                                <label class="col-sm-4 col-form-label text-end">Delivery Date:</label>
                                <div class="col-sm-8">
                                <input style="font-size:12px;" type="datetime-local" asp-for="Header.deliv_date" id="dv_date" name="dv_date" class="form-control" />
                                </div>
                            </div>
                            <div class="mb-2 row">
                                <label class="col-sm-4 col-form-label text-end">Customer Group : </label>
                                <div class="col-sm-8">
                                <select id="cust_ori" asp-for="Header.cust_group" asp-items="ViewBag.ListCustomerGroup" class="form-select select2" required>
                                        <option value="">Select an Option</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-2 row">
                                <label class="col-sm-4 col-form-label text-end">Origin : </label>
                                <div class="col-sm-8">
                                    <select id="origin_id" asp-for="Header.origin" asp-items="ViewBag.ListOrigin" class="form-select select2" required>
                                        <option value="">Select an Option</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-2 row">
                                <label class="col-sm-4 col-form-label text-end">Destination : </label>
                                <div class="col-sm-8">
                                    <select id="dest_id" asp-for="Header.dest" asp-items="ViewBag.ListDestination" class="form-select select2" required>
                                        <option value="">Select an Option</option>
                                    </select>
                                </div>
                            </div>

                        <div class="mb-2 row">
                            <label class="col-sm-4 col-form-label text-end">Multi Drop:</label>
                            <div class="col-sm-8">
                                <select id="multidrop" asp-for="Header.multidrop" class="form-select form-select-sm">
                                    <option value="false" selected>No</option>
                                    <option value="true">Yes</option>
                                </select>
                            </div>
                        </div>
                        </div>
                        <div class="col-md-4">
                        <div class="mb-2 row">
                            <label class="col-sm-4 col-form-label text-end">Serv. Type : </label>
                            <div class="col-sm-8">
                                <select id="servtype_ori" asp-for="Header.serv_type" asp-items="ViewBag.ListServiceType" class="form-select select2" required>
                                    <option value="">Select an Option</option>
                                </select>
                            </div>
                        </div>
                            <div class="mb-2 row">
                                <label class="col-sm-4 col-form-label text-end">Truck Size : </label>
                                <div class="col-sm-8">
                                    <select id="truck_size" asp-for="Header.truck_size" asp-items="ViewBag.ListTruckSize" class="form-select select2" required>
                                        <option value="">Select an Option</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-2 row">
                            <label class="col-sm-4 col-form-label text-end">Serv Moda : </label>
                            <div class="col-sm-8">
                                <select id="serv_moda" asp-for="Header.serv_moda" asp-items="ViewBag.ListModa" class="form-select select2" required>
                                    <option value="">Select an Option</option>
                                </select>
                            </div>
                            </div>
                            <div class="mb-2 row">
                            <label class="col-sm-4 col-form-label text-end">Chgr UoM : </label>
                            <div class="col-sm-8">
                                <select id="charge_uom" asp-for="Header.charge_uom" asp-items="ViewBag.ListUoM" class="form-select select2" required>
                                    <option value="">Select an Option</option>
                                </select>
                            </div>
                            </div>
                            <div class="mb-2 row">
                                <label class="col-sm-4 col-form-label text-end">Plan Vendor:</label>
                                <div class="col-sm-8">
                                    <div class="position-relative-custom">
                                        <input type="text"
                                                style="font-size:12px"
                                                asp-for="Header.vendor_plan"
                                                id="planVendor"
                                                name="vendorid"
                                               class="form-control form-control-with-button"
                                               placeholder="Select plan vendor..."
                                               readonly />
                                        <div class="input-group-append-custom">
                                            <button type="button"
                                                    class="btn btn-outline-secondary btn-sm"
                                                    onclick="openVendorModal('planVendor')"
                                                    title="Search plan vendor">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-2 row">
                                <label class="col-sm-4 col-form-label text-end">Actual Vendor:</label>
                                <div class="col-sm-8">
                                    <div class="position-relative-custom">
                                        <input type="text"
                                               style="font-size:12px"
                                               asp-for="Header.vendor_act"
                                               id="actualVendor"
                                               name="vendorid_act"
                                               class="form-control form-control-with-button"
                                               placeholder="Select actual vendor..."
                                               readonly />
                                        <div class="input-group-append-custom">
                                            <button type="button"
                                                    class="btn btn-outline-secondary btn-sm"
                                                    onclick="openVendorModal('actualVendor')"
                                                    title="Search actual vendor">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            
                            <div class="mb-2 row">
                                <label class="col-sm-4 col-form-label text-end">Truck ID:</label>
                                <div class="col-sm-8">
                                    <input style="font-size:12px" id="truckid" asp-for="Header.truck_no" class="form-control" type="text" />
                                </div>
                            </div>
                            <div class="mb-2 row">
                                <label class="col-sm-4 col-form-label text-end">Driver Name:</label>
                                <div class="col-sm-8">
                                    <input style="font-size:12px" id="drivername" asp-for="Header.driver_name" class="form-control" type="text" />
                                </div>
                            </div>
                            
                            <div class="mb-2 row">
                                <label class="col-sm-4 col-form-label text-end">Start/Finish Point:</label>
                                <div class="col-sm-8">
                                <select asp-for="Header.starting_point" class="form-select form-select-sm select2" id="starting_point" asp-items="ViewBag.ListStartingPoint" required>
                                    <option value="">Select an Option</option>
                                </select>
                                </div>
                            </div>
                            <div class="mb-2 row">
                                <label class="col-sm-4 col-form-label text-end">Multi Trip:</label>
                                <div class="col-sm-8">
                                    <select id="multitrip" asp-for="Header.multitrip" class="form-select form-select-sm">
                                        <option value="false" selected>No</option>
                                        <option value="true">Yes</option>
                                    </select>
                                </div>
                            </div>

                            <div class="mb-2 row">
                                <label class="col-sm-4 col-form-label text-end">Ritase:</label>
                                <div class="col-sm-8">
                                    <input style="font-size:12px" id="ritase_seq" asp-for="Header.ritase_seq" class="form-control" type="number" min="1" max="3" required value="1" readonly/>
                                </div>
                            </div>

                            <div class="mb-2 row">
                                <label class="col-sm-4 col-form-label text-end">Job Type:</label>
                                <div class="col-sm-8">
                                    <select asp-for="Header.job_type" class="form-select form-select-sm select2" id="job_type" asp-items="ViewBag.ListJobType" required>
                                        <option value="">Select an Option</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add Order Button -->
                <div class="d-flex align-items-center">
                    <button type="button" class="btn btn-sm btn-success" id="btnAddOrder">
                        <i class="fas fa-plus"></i> Add Orders
                    </button>
                    <span class="selected-orders-count" id="selectedCount" style="display: none;">
                        0 Orders Selected
                    </span>
                </div>

                <!-- Selected Orders Table -->
                <div class="detail-section">
                    <div class="table-container">
                        <table class="excel-table" id="selectedOrdersTable">
                            <thead>
                                <tr>
                                    <th style="width: 40px;">#</th>
                                    <th style="width: 50px;">Drop</th>
                                    <th style="width: 80px;">WH Code</th>
                                    <th style="width: 100px;">Invoice No</th>
                                    <th style="width: 80px;">Customer</th>
                                    <th style="width: 80px;">Consignee</th>
                                    <th style="width: 100px;">Origin</th>
                                    <th style="width: 100px;">Destination</th>
                                    <th style="width: 60px;">Charge UOM</th>
                                    <th style="width: 60px;">Service</th>
                                    <th style="width: 80px;">Truck Size</th>
                                    <th style="width: 80px;">Empty Pallet</th>
                                    <th style="width: 80px;">Return Cargo</th>
                                    <th style="width: 80px;">Overnight</th>
                                    <th style="width: 80px;">Cancel Cargo</th>
                                    <th style="width: 80px;">Diff Area</th>
                                    <th style="width: 50px;">Action</th>
                                </tr>
                            </thead>
                            <tbody id="selectedOrdersBody">
                                <tr>
                                    <td colspan="17" class="text-center text-muted">No orders selected. Click "Add Orders" to select orders.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="d-flex justify-content-end gap-2 mt-4 pt-3 border-top">
                    <button type="button" class="btn btn-secondary btn-sm">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-primary btn-sm">
                        <i class="fas fa-save"></i> Save
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Order Selection Modal -->
    <div class="modal fade" id="orderModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Select Orders</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between mb-3">
                        <div>
                            <strong>Available Orders for:</strong>
                            <span id="modalOrderInfo" class="text-primary"></span>
                        </div>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="selectAll">Select All</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="deselectAll">Deselect All</button>
                        </div>
                    </div>
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-sm order-table" id="availableOrdersTable">
                            <thead class="sticky-top">
                                <tr>
                                    <th><input type="checkbox" id="checkAll"></th>
                                    <th>WH Code</th>
                                    <th>Invoice No</th>
                                    <th>Customer</th>
                                    <th>Consignee</th>
                                    <th>Origin</th>
                                    <th>Destination</th>
                                    <th>Charge UOM</th>
                                    <th>Service</th>
                                    <th>Truck Size</th>
                                    <th>Pickup Date</th>
                                    <th>Delivery Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="availableOrdersBody">
                                <!-- Orders will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="me-auto">
                        <span class="badge bg-info" id="modalSelectedCount">0 selected</span>
                    </div>
                    <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-sm btn-primary" id="applySelection">Apply Selection</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Address Selection Modal -->
    <div class="modal fade" id="vendorModal" tabindex="-1" aria-labelledby="vendorModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                <h5 class="modal-title" id="vendorModalLabel">
                        <i class="fas fa-map-marker-alt"></i> Select <span id="modalTypeText">Plan</span> Vendor
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Search Input -->
                    <div class="mb-3">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text"
                                   autocomplete="off"
                                   class="form-control"
                                   id="vendorSearch"
                                   placeholder="Search..."
                                   onkeyup="searchVendor()">
                        </div>
                    </div>

                    <!-- Total Result -->
                    <div class="text-center text-muted" id="totalResult">
                        @* <i class="fas fa-search fa-2x mb-2"></i> *@
                        <p>Total result : <span id="qtyResult"></span> </p>
                    </div>

                    <!-- Loading Spinner -->
                    <div class="loading-spinner" id="loadingSpinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading vendor...</p>
                    </div>

                    

                    <!-- Vendor List -->
                    <div class="vendor-search" id="vendorList">
                        <!-- vendor items akan dimuat via JavaScript -->
                    </div>

                    <!-- No Results -->
                    <div class="text-center text-muted" id="noResults" style="display: none;">
                        <i class="fas fa-search fa-2x mb-2"></i>
                        <p>Vendor not found</p>
                    </div>

                    
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

@section Scripts{

    <script>
        // showLoading();
        $('#origin_id, #dest_id, #truck_size, #serv_moda ,#charge_uom').on('change', checkAndFetchVendor);
        function checkAndFetchVendor() {
            const originId = $('#origin_id').val();
            const destId = $('#dest_id').val();
            const truckSize = $('#truck_size').val();
            const servModa = $('#serv_moda').val();
            const chargeUom = $('#charge_uom').val();

            if (originId && destId && truckSize && servModa && chargeUom) {
                $.ajax({
                    url: '/Job/GetVendors',
                    type: 'GET',
                    data: {
                        originId: originId,
                        destId: destId,
                        truckSize : truckSize,
                        servModa: servModa,
                        chargeUom: chargeUom
                    },
                    success: function (data) {
                        if (data.success && data.vendors.length > 0) {
                            const selectedCode = data.vendors[0].supCode;
                            $('#planVendor').val(selectedCode);
                        } else {
                            $('#planVendor').val('');
                        }
                    },
                    error: function () {
                        $('#planVendor').val('');
                    }
                });
            }
        }
    </script>

    <script>
        function formatDateReadable(dateStr) {
            const date = new Date(dateStr);

            if (isNaN(date)) return dateStr; // fallback kalau input invalid

            return date.toLocaleString("en-US", {
                year: "numeric",
                month: "long",
                day: "numeric",
                // hour: "2-digit",
                // minute: "2-digit"
            });
        }

        $('#multitrip').on('change', function () {
            if ($(this).val() === 'true') {
                $('#ritase_seq').prop('readonly', false);
                $('#ritase_seq').val(2);

                $('#multidrop').val('false').trigger('change');
            }
        });

        $('#multidrop').on('change', function () {
            if ($(this).val() === 'true') {
                $('#ritase_seq').prop('readonly', true);
                $('#ritase_seq').val(1);

                $('#multitrip').val('false').trigger('change');
            }
        });


        $(document).ready(function() {
            // Initialize Select2
            $('.form-select').select2({
                theme: 'bootstrap-5',
                width: '100%'
            });

            let realOrders = [];

            let selectedOrders = [];

            // Add Order Button Click
            $('#btnAddOrder').click(function() {
                console.log("selectedOrders : ", selectedOrders);
                loadAvailableOrders();
                $('#orderModal').modal('show');
            });

            // Load available orders based on header information
            function loadAvailableOrders() {
            const origin = $('#origin_id option:selected').text();
            const destination = $('#dest_id option:selected').text();
            const pickupDate = $('#pickup_date').val();
            const deliveryDate = $('#dv_date').val();

            $.ajax({
                url: '/Job/GetOrders',
                type: 'GET',
                data: {
                    originId: origin,
                    destArea: destination,
                    pickupDate : pickupDate,
                    deliveryDate: deliveryDate,
                    multidrop: $('#multidrop').val() === "true",
                },
                success: function (res) {
                    console.log("Orders:", res);

                    if (!res.success) {
                        showToast("Gagal ambil data order", "error");
                        return;
                    }

                    const orders = res.data; // ambil array orders
                    realOrders = orders;
                    const tbody = $('#availableOrdersBody');
                    tbody.empty();

                    orders.forEach(function(order, index) {
                        const row = `
                            <tr>
                                <td><input type="checkbox" class="order-checkbox" data-order-id="${order.id_seq}"></td>
                                <td>${order.wh_code}</td>
                                <td>${order.inv_no}</td>
                                <td title="${order.sub_custid}">${order.sub_custid}</td>
                                <td title="${order.cnee_code}">${order.cnee_code}</td>
                                <td>${order.origin_id ?? ''}</td>
                                <td>${order.dest_area ?? ''}</td>
                                <td>${order.uom ?? ''}</td>
                                <td>${order.serv_req ?? ''}</td>
                                <td>${order.truck_size ?? ''}</td>
                                <td>${order.pickup_date ? new Date(order.pickup_date).toLocaleString() : ''}</td>
                                <td>${order.delivery_date ? new Date(order.delivery_date).toLocaleString() : ''}</td>
                                <td><span class="badge bg-success">${order.mceasy_status ?? ''}</span></td>
                            </tr>
                        `;
                        tbody.append(row);
                    });

                    updateModalSelectedCount();
                },
                error: function (xhr) {
                    console.error("Error:", xhr.responseText);
                    showToast("Terjadi error saat ambil data order", "error");
                }
            });
            const formatPickupDate = formatDateReadable(pickupDate);
            const formattedDate = formatDateReadable(deliveryDate);
            $('#modalOrderInfo').text(`${origin} → ${destination}, Pickup Date: ${formatPickupDate}`);
        }

            // Check All functionality
            $('#checkAll').change(function() {
                const isChecked = $(this).is(':checked');
                $('.order-checkbox').prop('checked', isChecked);
                updateModalSelectedCount();
            });

            // Individual checkbox change
            $(document).on('change', '.order-checkbox', function() {
                updateModalSelectedCount();
                updateCheckAllState();
            });

            // Select All button
            $('#selectAll').click(function() {
                $('.order-checkbox').prop('checked', true);
                $('#checkAll').prop('checked', true);
                updateModalSelectedCount();
            });

            // Deselect All button
            $('#deselectAll').click(function() {
                $('.order-checkbox').prop('checked', false);
                $('#checkAll').prop('checked', false);
                updateModalSelectedCount();
            });

            // Update modal selected count
            function updateModalSelectedCount() {
                const count = $('.order-checkbox:checked').length;
                $('#modalSelectedCount').text(`${count} selected`);
            }

            // Update check all state
            function updateCheckAllState() {
                const total = $('.order-checkbox').length;
                const checked = $('.order-checkbox:checked').length;
                $('#checkAll').prop('checked', total === checked && total > 0);
            }

            // Apply Selection
            $('#applySelection').click(function() {
                selectedOrders = selectedOrders;
                $('.order-checkbox:checked').each(function() {
                    const orderId = $(this).data('order-id');
                    const orderData = realOrders.find(o => o.id_seq === orderId);
                    if (orderData) {
                        console.log("before apply : ",selectedOrders)
                        selectedOrders.push(orderData);
                        console.log("order applied : ",orderData);
                        console.log("after applied : ",selectedOrders)
                    }
                });

                renderSelectedOrders();
                updateSelectedCount();
                $('#orderModal').modal('hide');
            });

            // Render selected orders in main table
            function renderSelectedOrders() {
                const tbody = $('#selectedOrdersBody');
                tbody.empty();

                if (selectedOrders.length === 0) {
                    tbody.append('<tr><td colspan="17" class="text-center text-muted">No orders selected. Click "Add Orders" to select orders.</td></tr>');
                    return;
                }

                selectedOrders.forEach((order, index) => {
                    const renderYesNoSelect = (name, value, selected = "No") => {
                        if(value == 1){
                            selected = "Yes"
                        }
                        return `
                            <select class="form-select form-select-sm" name="${name}">
                                <option value="No" ${selected === "No" ? 'selected' : ''}>No</option>
                                <option value="Yes" ${selected === "Yes" ? 'selected' : ''}>Yes</option>
                            </select>`;
                    };

                    const row = `
                        <tr data-order-id="${order.id_seq}">
                            <td class="text-center">${index + 1}</td>
                            <td>
                                <input type="number" name="Details[${index}].drop_seq" value="${index + 1}" class="form-control form-control-sm" style="width:50px;" />
                            </td>
                            <td><input type="text" name="Details[${index}].wh_code" class="form-control form-control-sm" value="${order.wh_code}" readonly /></td>
                            <td><input type="text" name="Details[${index}].inv_no" class="form-control form-control-sm" value="${order.inv_no}" readonly /></td>
                            <td><input type="text" name="Details[${index}].sub_custid" class="form-control form-control-sm" value="${order.sub_custid}" readonly /></td>
                            <td><input type="text" name="Details[${index}].cnee_code" class="form-control form-control-sm" value="${order.cnee_code}" readonly /></td>
                            <td><input type="text" name="Details[${index}].origin_id" class="form-control form-control-sm" value="${order.origin_id}" readonly /></td>
                            <td><input type="text" name="Details[${index}].dest_area" class="form-control form-control-sm" value="${order.dest_area}" readonly /></td>
                            <td><input type="text" name="Details[${index}].uom" class="form-control form-control-sm" value="${order.uom}" readonly /></td>
                            <td><input type="text" name="Details[${index}].serv_req" class="form-control form-control-sm" value="${order.serv_req}" readonly /></td>
                            <td><input type="text" name="Details[${index}].truck_size" class="form-control form-control-sm" value="${order.truck_size}" /></td>
                            <td>${renderYesNoSelect(`Details[${index}].flag_ep`, `${order.flag_ep}`)}</td>
                            <td>${renderYesNoSelect(`Details[${index}].flag_rc`, `${order.flag_rc}`)}</td>
                            <td>${renderYesNoSelect(`Details[${index}].flag_ov`, `${order.flag_ov}`)}</td>
                            <td>${renderYesNoSelect(`Details[${index}].flag_cc`, `${order.flag_cc}`)}</td>
                            <td>${renderYesNoSelect(`Details[${index}].flag_diffa`, `${order.flag_diffa}`)}</td>
                            <td>
                                <button type="button" class="btn btn-sm btn-danger btn-remove-order" data-order-id="${order.id_seq}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.append(row);
                });
            }

            // Remove order from selection
            $(document).on('click', '.btn-remove-order', function() {
                const orderId = $(this).data('order-id');
                selectedOrders = selectedOrders.filter(o => o.id_seq !== orderId);
                renderSelectedOrders();
                updateSelectedCount();
            });

            // Update selected count badge
            function updateSelectedCount() {
                const count = selectedOrders.length;
                const badge = $('#selectedCount');
                if (count > 0) {
                    badge.text(`${count} Orders Selected`).show();
                } else {
                    badge.hide();
                }
            }

            // Form submission
            $('#orderForm').submit(function(e) {
                e.preventDefault();
                handleSave();
            });

            // Save and New
            $('#btnSaveNew').click(function() {
                handleSave(true);
            });

            // Handle save
            function handleSave(saveAndNew = false) {
                const header = {
                    job_id: $('#jobid').val(),
                    origin_id: $('#origin_id').val(),
                    dest_area: $('#dest_id').val(),
                    pickup_date: $('#pickup_date').val(),
                    dvdate : $('#dv_date').val(),
                    vendor_id: $('#planVendor').val(),
                    vendor_act: $('#actualVendor').val(),
                    truck_id: $('#truckid').val(),
                    driver_name: $('#drivername').val(),
                    truck_size: $('#truck_size').val(),
                    serv_moda: $('#serv_moda').val(),
                    serv_type : $('#servtype_ori').val(),
                    charge_uom: $('#charge_uom').val(),
                    multidrop: $('#multidrop').val() === "true",
                    multitrip: $('#multitrip').val() === "true",
                    ritase_seq: $('#ritase_seq').val(),
                    job_type: $('#job_type').val(),
                    cust_group : $('#cust_ori').val(),
                    starting_point : $('#starting_point').val()
                };

                const details = [];
                $('#selectedOrdersBody tr[data-order-id]').each(function(index) {
                    const row = $(this);
                    const detail = {
                        id_seq: row.data('order-id'),
                        drop_seq: row.find('[name*=".drop_seq"]').val(),
                        wh_code: row.find('[name*=".wh_code"]').val(),
                        inv_no: row.find('[name*=".inv_no"]').val(),
                        sub_custid: row.find('[name*=".sub_custid"]').val(),
                        cnee_code: row.find('[name*=".cnee_code"]').val(),
                        origin_id: row.find('[name*=".origin_id"]').val(),
                        dest_area: row.find('[name*=".dest_area"]').val(),
                        truck_size: row.find('[name*=".truck_size"]').val(),
                        uom: row.find('[name*=".uom"]').val(),
                        serv_req: row.find('[name*=".serv_req"]').val(),
                        flag_ep: row.find('[name*=".flag_ep"]').val() == 'Yes' ? 1 : 0,
                        flag_rc: row.find('[name*=".flag_rc"]').val() == 'Yes' ? 1 : 0,
                        flag_ov: row.find('[name*=".flag_ov"]').val() == 'Yes' ? 1 : 0,
                        flag_cc: row.find('[name*=".flag_cc"]').val() == 'Yes' ? 1 : 0,
                        flag_diffa: row.find('[name*=".flag_diffa"]').val() == 'Yes' ? 1 : 0
                    };
                    details.push(detail);
                });

                const dataToPost = {
                    FormJobHeader: header,
                    FormJobDetails: details,
                    SaveAndNew: saveAndNew
                };

                // Log data to console for debugging
                console.log('=== DATA TO POST ===');
                console.log('Header:', header);
                console.log('Details Count:', details.length);
                console.log('Details:', details);
                console.log('Data Payload:', dataToPost);

                // return;

                // Kirim lewat AJAX

                let url = '/Job/Save';
                const jobid = $('#jobid').val();

                if(jobid != "Auto Generate"){
                    url = '/Job/Save/'+jobid
                }
                showLoading();
                $.ajax({
                    url: url,
                    type: 'POST',
                    data: JSON.stringify(dataToPost),
                    contentType: 'application/json',
                    success: function (res) {
                        hideLoading();
                        Swal.fire({
                            position: "center",
                            icon: "success",
                            title: "Success!",
                            text : res.message,
                            showConfirmButton: false,
                            timer: 1500
                        }).then((result) => {
                            window.location.href = '/Job/Index';
                        });   
                    },
                    error: function (e) {
                        hideLoading();
                        console.log(e)
                    }
                });

            }

            // Reset form
            function resetForm() {
                $('#orderForm')[0].reset();
                selectedOrders = [];
                renderSelectedOrders();
                updateSelectedCount();

                // Reset select2 dropdowns
                $('.form-select').val('').trigger('change');

                // Set default values
                $('#jobid').val('');
                $('#dv_date').val('2025-01-15');
                $('#origin_id').val('JKT').trigger('change');
                $('#dest_id').val('SBY').trigger('change');
                $('#truck_size').val('CDD').trigger('change');
                $('#serv_moda').val('DELIVERY').trigger('change');
                $('#charge_uom').val('TRIP').trigger('change');
                $('#vendorid').val('V001').trigger('change');
                $('#vendorid_act').val('V001').trigger('change');
                $('#truckid').val('T001').trigger('change');
                $('#drivername').val('Budi Santoso').trigger('change');
                $('#multidrop').val('No').trigger('change');
            }

            // Initial load
            updateSelectedCount();

            const jobid = $('#jobid').val();
            if (jobid) {
                fetchDetail(jobid);
            }

            function fetchDetail(jobid) {
                $.ajax({
                    url: '/Job/GetJobDetails',
                    type: 'GET',
                    data: { jobid: jobid },
                    success: function (res) {
                        if (res.success && res.data.length > 0) {
                            console.log("Detail Data:", res.data);
                            res.data.forEach(function(item) {
                                selectedOrders.push(item)
                            });
                            renderSelectedOrders();
                            updateSelectedCount();

                        } else {
                            console.log('No detail data');
                        }
                    },
                    error: function () {
                        Swal.fire('Oops', 'Gagal mengambil data detail', 'error');
                    }
                });
            }

            // on servtype_ori change
            $('#servtype_ori').change(function () {
                const val = $(this).val();
                console.log('VALUE:', val);

                if (val === 'LTL') {
                    console.log('OPTION VALUE:', $('#truck_size').find('option').map(function(){return this.value}).get());
                    $('#truck_size')
                        .val('NON-SIZE')
                        .trigger('change.select2');
                }
            });

        });
    </script>

    <script>
        let currentVendorType = '';
        // Function untuk membuka modal alamat
        async function openVendorModal(type = '') {
            currentVendorType = type;

            // Show modal
            const vendorModal = new bootstrap.Modal(document.getElementById('vendorModal'));
            vendorModal.show();

            // Show loading
            showLoading2(true);

            // Reset search
            document.getElementById('vendorSearch').value = '';

            try {
                await loadVendor();
            } catch (error) {
                console.error('Error loading vendor:', error);
                showNoResults(true);
            } finally {
                showLoading2(false);
            }
        }
        let allVendor = [];
        let filteredVendor = [];
        // Simulasi API call untuk load addresses
        async function loadVendor() {
            const originId = $('#origin_id').val();
            const destId = $('#dest_id').val();
            const truckSize = $('#truck_size').val();
            const servModa = $('#serv_moda').val();
            const chargeUom = $('#charge_uom').val();
            const payload = {
                originId: originId,
                destId: destId,
                truckSize : truckSize,
                servModa: servModa,
                chargeUom: chargeUom
            }
            await new Promise(resolve => setTimeout(resolve, 1000));
            // let url = `/Job/GetVendor?id=${1}&category=${1}`;
            const url = `/Job/GetVendors?originId=${originId}&destId=${destId}&truckSize=${truckSize}&servModa=${servModa}&chargeUom=${chargeUom}`;
            const response = await fetch(url, {
                method: "GET",
                headers: {
                  "Accept": "application/json"
                }
            });
            if (!response.ok) {
                throw new Error('Failed to fetch vendor');
            }
            const data = await response.json();
            const vendors = data?.data || [];
            allVendor = vendors;
            filteredVendor = [...allVendor];
            renderVendor();
        }

        // Function untuk render vendor ke DOM
        function renderVendor() {
            const vendorList = document.getElementById('vendorList');
            vendorList.innerHTML = '';

            const qtyResult = document.getElementById('qtyResult');
            qtyResult.innerHTML = '0';

            if (filteredVendor.length === 0) {
                showNoResults(true);
                return;
            }

            // Get current selected address untuk comparison
            let selectedVendor = '';

            console.log("CURRENT VENDOR TYPE : ", currentVendorType);

            if (currentVendorType === 'planVendor') {
                selectedVendor = document.getElementById('planVendor').value;
            } else {
                selectedVendor = document.getElementById('actualVendor').value;
            }

            console.log("FILTERED VENDOR ", filteredVendor)
            console.log("SELECTED VENDOR ", selectedVendor)

            filteredVendor.forEach((vendor, index) => {
                const vendorItem = createVendorItem(vendor, index, selectedVendor);
                console.log('vendor Item : ', vendorItem)
                vendorList.appendChild(vendorItem);
            });

            qtyResult.innerHTML = filteredVendor.length;

            // showNoResults(false);
        }

        // Function untuk membuat elemen vendor item
        function createVendorItem(vendor, index, selectedVendor = '') {
            const div = document.createElement('div');
            // Check jika address ini sudah dipilih di field lain
            const isDisabled = selectedVendor && selectedVendor === vendor.vendor_code;

            div.className = `vendor-item ${isDisabled ? 'disabled' : ''}`;

            if (!isDisabled) {
                div.onclick = () => selectVendor(vendor);
            }
            const vendorBadge = vendor.vendor_code ? '<span class="badge bg-info ms-1 font-sm"> '+ vendor.vendor_code +' </span>' : '';
            const disabledBadge = isDisabled ? '<span class="badge bg-danger ms-1">Already Selected</span>' : '';

            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="mb-2">
                            <i class="fas fa-truck me-1"></i>
                            ${vendor.vendor_code}
                            ${disabledBadge}
                        </h6>
                        <p class="mb-1 text-muted">
                            <i class="fas fa-map-marker-alt me-1"></i>
                            ${vendor.origin} -> ${vendor.destination}

                        </p>
                        <div class="row">
                            <div class="col-md-6">
                                <small class="text-muted">
                                    <i class="fas fa-box me-1"></i>
                                    ${vendor.service} - ${vendor.moda} - ${vendor.truck_size}
                                </small>
                            </div>
                            <div class="col-md-6 d-none">
                                ${vendor.vendor_code ? `
                                    <small class="text-muted">
                                        <i class="fas fa-user me-1"></i>
                                        ${vendor.vendor_code}
                                        ${vendor.vendor_code ? ' - ' + vendor.vendor_name : ''}
                                    </small>
                                ` : ''}
                            </div>
                        </div>
                        ${vendor.vendor_code && vendor.vendor_name ? `
                            <small class="text-info d-none">
                                <i class="fas fa-clock me-1"></i>
                                Service Time: ${vendor.vendor_code} - ${vendor.vendor_name}
                            </small>
                        ` : ''}
                    </div>
                    <div class="text-end d-none">
                        <small class="text-muted d-none">ID: ${vendor.vendor_code}</small>
                    </div>
                </div>
            `;

            return div;
        }

        // Function untuk select vendor
        function selectVendor(vendor) {
            // Fill form fields berdasarkan type
            if (currentVendorType === 'planVendor') {
                document.getElementById('planVendor').value = vendor.vendor_code;
                document.getElementById('actualVendor').value = vendor.vendor_code;
            } else if (currentVendorType === 'actualVendor') {
                document.getElementById('actualVendor').value = vendor.vendor_code;
            }

            // Close modal
            const vendorModal = bootstrap.Modal.getInstance(document.getElementById('vendorModal'));
            vendorModal.hide();

            // Optional: Show success feedback
            // const typeText = currentAddressType === 'origin' ? 'Origin' : 'Destination';
            // showSuccessToast(`${typeText} address selected: ${address.fenceName}`);
        }

        // Function untuk search vendor
        function searchVendor() {
            const searchTerm = document.getElementById('vendorSearch').value.toLowerCase();
            if (searchTerm === '') {
                filteredVendor = [...allVendor];
            } else {
                filteredVendor = allVendor.filter(vendor =>
                    vendor.vendor_code?.toLowerCase().includes(searchTerm) ||
                    vendor.vendor_name?.toLowerCase().includes(searchTerm) ||
                    vendor.origin?.toLowerCase().includes(searchTerm) ||
                    vendor.destination?.toLowerCase().includes(searchTerm) ||
                    vendor.truck_size?.toLowerCase().includes(searchTerm) ||
                    vendor.service?.toLowerCase().includes(searchTerm) ||
                    vendor.moda?.toLowerCase().includes(searchTerm)
                );
            }
            renderVendor();
        }

        // Helper functions
        function showLoading2(show) {
            if(show){
                showNoResults(false);
            }
            document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
            document.getElementById('vendorList').style.display = show ? 'none' : 'block';
        }

        function showNoResults(show) {
            document.getElementById('noResults').style.display = show ? 'block' : 'none';
        }
    </script>

}
